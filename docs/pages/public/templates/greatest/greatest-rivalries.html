<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Greatest Rivalries - McKnight's American Football Rankings</title>
    <meta name="description" content="The greatest rivalries in high school football history, ranked by the total Pulse Rate Index across all qualifying meetings.">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static-football-rankings/css/styles.css" rel="stylesheet">

    <style>
        /* Rivalry pair display */
        .rivalry-pair {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .rivalry-vs {
            font-size: 0.75rem;
            font-weight: 700;
            color: #6c757d;
            padding: 1px 5px;
            border: 1px solid #dee2e6;
            border-radius: 3px;
            white-space: nowrap;
        }
        .rivalry-team {
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Series leader badge */
        .series-leader {
            font-size: 0.78rem;
            color: #495057;
            white-space: nowrap;
        }
        .series-tied {
            color: #6c757d;
            font-style: italic;
        }

        /* Total PRI bar */
        .pri-bar-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pri-bar {
            height: 8px;
            background: linear-gradient(90deg, #0d6efd, #6610f2);
            border-radius: 4px;
            min-width: 4px;
        }
        .pri-label {
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
            color: #495057;
        }

        /* Season range */
        .season-range {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
        }

        /* Meetings badge */
        .meetings-badge {
            font-size: 0.78rem;
            font-weight: 700;
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* Rank column */
        .rank-cell {
            font-weight: 700;
            color: #6c757d;
            font-size: 0.9rem;
        }
        .rank-cell.top-10 { color: #0d6efd; }
        .rank-cell.top-25 { color: #198754; }

        /* Expandable game list */
        .games-toggle {
            font-size: 0.78rem;
            cursor: pointer;
            color: #0d6efd;
            text-decoration: none;
            white-space: nowrap;
        }
        .games-toggle:hover { text-decoration: underline; }
        .games-list {
            font-size: 0.8rem;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 8px 12px;
            margin-top: 6px;
        }
        .game-row {
            display: flex;
            gap: 12px;
            padding: 3px 0;
            border-bottom: 1px solid #dee2e6;
            align-items: center;
        }
        .game-row:last-child { border-bottom: none; }
        .game-season { font-weight: 600; width: 44px; flex-shrink: 0; }
        .game-score  { font-weight: 600; color: #155724; white-space: nowrap; }
        .game-margin { color: #6c757d; white-space: nowrap; }

        /* Methodology */
        .methodology-card {
            border-left: 4px solid #0d6efd;
            background: #f8f9fa;
        }

        /* Table headers */
        .table thead th {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6c757d;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            vertical-align: middle;
        }

        /* Hide detail row background when collapsed */
        .games-detail-row td {
            background: transparent;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .col-meetings, .col-range, .col-pri { display: none; }
        }

        /* Loading */
        #loadingIndicator { text-align: center; padding: 3rem; color: #6c757d; }
        #noResults { text-align: center; padding: 2rem; color: #6c757d; display: none; }

        .last-updated { font-size: 0.8rem; color: #6c757d; }
    </style>
</head>
<body>

    <div class="header-banner">
        <img src="/static-football-rankings/images/football-field-top.jpg" alt="Football Field Header" class="w-100" />
    </div>

    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/static-football-rankings/index.html">Home</a></li>
                <li class="breadcrumb-item"><a href="/static-football-rankings/pages/public/greatest/index.html">Greatest Games &amp; Rivalries</a></li>
                <li class="breadcrumb-item active" aria-current="page">Greatest Rivalries</li>
            </ol>
        </nav>
    </div>

    <div class="container mt-4">

        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-start mb-2 flex-wrap gap-2">
            <div>
                <h1 class="mb-1">Greatest Rivalries</h1>
                <p class="text-muted mb-0">The most consistently great head-to-head series in high school football history</p>
            </div>
            <div class="text-end">
                <span class="last-updated">Last updated: <span id="lastUpdated">--</span></span>
            </div>
        </div>

        <!-- Methodology -->
        <div class="card methodology-card mb-4 mt-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">How Rivalries Are Ranked</h5>
                    <button class="btn btn-sm btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#methodologyBody"
                            aria-expanded="false" aria-controls="methodologyBody">
                        Show / Hide
                    </button>
                </div>

                <div class="collapse" id="methodologyBody">
                    <hr>
                    <h6>The Rivalry Score</h6>
                    <p>Rivalries are ranked by <strong>Total PRI</strong> — the sum of Pulse Rate Index scores across all qualifying meetings between two programs. This rewards both volume and quality: two programs that play each other frequently <em>and</em> play great, close games will rank highest.</p>

                    <h6>What Counts as a Qualifying Meeting</h6>
                    <p>A game qualifies for the rivalry pool if both programs were elite that season (Combined Rating &gt; 20, five-year average &gt; 20) and the margin was 8 points or fewer. Games outside that window still count toward the all-time head-to-head record, but not toward the rivalry score.</p>

                    <h6>Minimum Threshold</h6>
                    <p>A rivalry must have at least <span id="minMeetings">--</span> qualifying meetings to appear on this list. A single great game is not a rivalry — it belongs on the <a href="/static-football-rankings/pages/public/greatest/greatest-games.html">Greatest Games</a> page.</p>

                    <h6>All-Time Record</h6>
                    <p>The head-to-head record shown includes <em>all</em> games ever played between the two programs — not just qualifying meetings. This gives the full picture of how the series has gone across all eras.</p>

                    <h6>Limitations</h6>
                    <p class="mb-1" style="font-size:0.9rem;">
                        <span style="color:#fd7e14;">&#9888;</span>
                        <strong>Data coverage affects results.</strong> Rivalries in states or eras with incomplete game coverage will be underrepresented. A rivalry that played 60 times but only 20 games are in the database will rank lower than it deserves.
                    </p>
                    <p class="mb-0" style="font-size:0.9rem;">
                        <span style="color:#fd7e14;">&#9888;</span>
                        <strong>Program classification is ongoing.</strong> Some states have not yet completed the 11-man vs. 8-man classification review. Results improve as that work progresses.
                    </p>
                </div>
            </div>
        </div>

        <!-- Result count -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="text-muted" style="font-size:0.85rem;" id="resultCount">Loading...</span>
            <a href="/static-football-rankings/pages/public/greatest/greatest-games.html"
               class="btn btn-sm btn-outline-primary">View Greatest Games</a>
        </div>

        <!-- Loading state -->
        <div id="loadingIndicator">
            <div class="spinner-border text-primary mb-3" role="status"></div>
            <p>Loading rivalries data...</p>
        </div>

        <!-- Main table -->
        <div id="tableWrapper" style="display:none;">
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle" id="rivalsTable">
                    <thead>
                        <tr>
                            <th style="width:44px;">#</th>
                            <th>Rivalry</th>
                            <th class="col-meetings text-center" style="width:90px;">Qualifying<br>Meetings</th>
                            <th class="col-pri" style="width:140px;">Total PRI</th>
                            <th class="col-range text-center" style="width:110px;">Years</th>
                            <th>All-Time Record</th>
                            <th style="width:70px;"></th>
                        </tr>
                    </thead>
                    <tbody id="rivalsTableBody"></tbody>
                </table>
            </div>
            <div id="noResults">No rivalries found.</div>
        </div>

    </div><!-- /container -->

    <!-- Comments -->
    <div class="container">
        <div class="comments-section mt-4">
            <h3>Comments</h3>
            <div id="authContainer" class="mb-3"></div>
            <div id="commentForm" class="mb-4" style="display: none">
                <div class="card">
                    <div class="card-body">
                        <textarea id="commentText" class="form-control mb-2" rows="3"
                                  placeholder="Share your thoughts on the greatest rivalries..."></textarea>
                        <div class="d-flex justify-content-between align-items-center">
                            <button id="submitComment" class="btn btn-primary">Post Comment</button>
                            <small class="text-muted">Posting as <span id="authorName">Anonymous</span></small>
                        </div>
                    </div>
                </div>
            </div>
            <div id="commentsList"></div>
        </div>
    </div>

    <footer class="mt-5 mb-3">
        <div class="text-center">
            <p>&#169; 2025 McKnight's Football Rankings</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/static-football-rankings/js/main.js"></script>

    <script>
    (function () {
        'use strict';

        const DATA_URL = '/static-football-rankings/data/greatest-rivalries/greatest-rivalries.json';

        // ── PRI bar (scaled to max total PRI in dataset) ──────────────────────
        let maxTotalPri = 1;

        function priBar(total_pri) {
            const pct = maxTotalPri > 0 ? total_pri / maxTotalPri : 0;
            const w   = Math.max(4, Math.round(pct * 120));
            return `<div class="pri-bar-wrap">
                        <div class="pri-bar" style="width:${w}px;"></div>
                        <span class="pri-label">${total_pri.toFixed(1)}</span>
                    </div>`;
        }

        // ── Rank cell class ───────────────────────────────────────────────────
        function rankClass(rank) {
            if (rank <= 10) return 'rank-cell top-10';
            if (rank <= 25) return 'rank-cell top-25';
            return 'rank-cell';
        }

        // ── Expandable game list ──────────────────────────────────────────────
        function buildGamesList(games, id) {
            const rows = games.map(g => {
                const homeWon   = g.margin >= 0;
                const winner    = homeWon ? g.home : g.visitor;
                const loser     = homeWon ? g.visitor : g.home;
                const winScore  = homeWon ? g.home_score : g.visitor_score;
                const lossScore = homeWon ? g.visitor_score : g.home_score;
                const margin    = Math.abs(g.margin);
                const marginTxt = margin === 0 ? 'TIE' : `${margin} pt`;
                return `<div class="game-row">
                    <span class="game-season">${g.season}</span>
                    <span class="game-score">${escapeHtml(winner)} ${winScore}-${lossScore}</span>
                    <span class="game-margin">(${marginTxt})</span>
                    <span class="pri-label ms-auto">${g.pri_normalised.toFixed(1)}</span>
                </div>`;
            }).join('');

            return `<div class="games-list collapse" id="games-${id}">
                        <div class="fw-semibold mb-1" style="font-size:0.78rem;color:#6c757d;">
                            QUALIFYING MEETINGS (${games.length})
                        </div>
                        ${rows}
                    </div>`;
        }

        // ── Build one table row ───────────────────────────────────────────────
        function buildRow(r, idx) {
            const leaderClass = r.series_leader.toLowerCase().startsWith('series tied')
                ? 'series-tied' : '';
            const yearRange = r.season_first === r.season_last
                ? `${r.season_first}`
                : `${r.season_first}&ndash;${r.season_last}`;

            const gamesHtml = buildGamesList(r.qualifying_games || [], idx);

            return `<tr>
                <td class="${rankClass(r.rank)}">${r.rank}</td>
                <td>
                    <div class="rivalry-pair">
                        <span class="rivalry-team">${escapeHtml(r.team_a)}</span>
                        <span class="rivalry-vs">vs</span>
                        <span class="rivalry-team">${escapeHtml(r.team_b)}</span>
                    </div>
                </td>
                <td class="col-meetings text-center">
                    <span class="meetings-badge">${r.qualifying_meetings}</span>
                </td>
                <td class="col-pri">${priBar(r.total_pri)}</td>
                <td class="col-range text-center">
                    <span class="season-range">${yearRange}</span>
                </td>
                <td>
                    <span class="series-leader ${leaderClass}">${escapeHtml(r.series_leader)}</span>
                </td>
                <td>
                    <a class="games-toggle" data-bs-toggle="collapse"
                       href="#games-${idx}" role="button"
                       aria-expanded="false">
                        Games &#9660;
                    </a>
                </td>
            </tr>
            <tr class="games-detail-row">
                <td colspan="7" class="p-0 border-0">
                    ${gamesHtml}
                </td>
            </tr>`;
        }

        function escapeHtml(str) {
            const d = document.createElement('div');
            d.textContent = str || '';
            return d.innerHTML;
        }

        // ── Load data ─────────────────────────────────────────────────────────
        fetch(DATA_URL)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .then(data => {
                const items = data.items || [];
                maxTotalPri = items.length > 0
                    ? Math.max(...items.map(i => i.total_pri))
                    : 1;

                // Metadata
                if (data.metadata) {
                    if (data.metadata.timestamp) {
                        const d = new Date(data.metadata.timestamp);
                        document.getElementById('lastUpdated').textContent =
                            d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                    if (data.metadata.min_meetings) {
                        document.getElementById('minMeetings').textContent = data.metadata.min_meetings;
                    }
                }

                document.getElementById('resultCount').textContent =
                    `Showing ${items.length} rivalr${items.length !== 1 ? 'ies' : 'y'}`;

                const tbody = document.getElementById('rivalsTableBody');
                if (items.length === 0) {
                    document.getElementById('noResults').style.display = 'block';
                } else {
                    tbody.innerHTML = items.map((r, i) => buildRow(r, i)).join('');
                }

                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('tableWrapper').style.display = 'block';
            })
            .catch(err => {
                console.error('Failed to load rivalries data:', err);
                document.getElementById('loadingIndicator').innerHTML =
                    '<p class="text-danger">Unable to load rivalries data. Please try again later.</p>';
            });

    })();
    </script>

    COMMENTS_SCRIPT_PLACEHOLDER

</body>
</html>
###############################################################################
# GenerateAllPages.ps1
# Comprehensive static page generator for McKnight's American Football Rankings
###############################################################################

#region Configuration
Write-Host 'Initializing static page generation...' -ForegroundColor Green

# Base paths
$rootDir = "C:\Users\demck\OneDrive\Football_2024\static-football-rankings"
$docsDir = Join-Path $rootDir "docs"
$dataDir = Join-Path $docsDir "data"
$templateBaseDir = Join-Path $docsDir "pages\public\templates"
$outputBaseDir = Join-Path $docsDir "pages\public"

# Create necessary directories
$directories = @(
    (Join-Path $outputBaseDir "decades"),
    (Join-Path $outputBaseDir "states"),
    (Join-Path $outputBaseDir "all-time"),
    (Join-Path $outputBaseDir "latest-season")
)

foreach ($dir in $directories) {
    if (-not (Test-Path $dir)) {
        New-Item -ItemType Directory -Path $dir -Force | Out-Null
    }
}

# Verify paths exist
if (-not (Test-Path $dataDir)) {
    Write-Error "Data directory not found: $dataDir"
    exit 1
}

if (-not (Test-Path $templateBaseDir)) {
    Write-Warning "Template directory not found, creating: $templateBaseDir"
    New-Item -ItemType Directory -Path $templateBaseDir -Force | Out-Null
}
#endregion Configuration

#region Template Verification
function Test-RequiredTemplates {
    $requiredTemplates = @(
        # Decade templates
        @{ Path = Join-Path $templateBaseDir "decades\decade-teams-template.html"; Description = "Decade Teams Template"; Critical = $true },
        @{ Path = Join-Path $templateBaseDir "decades\decade-programs-template.html"; Description = "Decade Programs Template"; Critical = $true },
        # State templates
        @{ Path = Join-Path $templateBaseDir "states\state-teams-template.html"; Description = "State Teams Template"; Critical = $true },
        @{ Path = Join-Path $templateBaseDir "states\state-programs-template.html"; Description = "State Programs Template"; Critical = $true },
        # All-time templates
        @{ Path = Join-Path $templateBaseDir "all-time\all-time-teams-template.html"; Description = "All-Time Teams Template"; Critical = $false },
        @{ Path = Join-Path $templateBaseDir "all-time\all-time-programs-template.html"; Description = "All-Time Programs Template"; Critical = $false },
        # Latest season template
        @{ Path = Join-Path $templateBaseDir "latest-season\latest-season-template.html"; Description = "Latest Season Template"; Critical = $false },
        # Index templates
        @{ Path = Join-Path $templateBaseDir "index\decades-index-template.html"; Description = "Decades Index Template"; Critical = $true },
        @{ Path = Join-Path $templateBaseDir "index\states-index-template.html"; Description = "States Index Template"; Critical = $true },
        @{ Path = Join-Path $templateBaseDir "index\all-time-index-template.html"; Description = "All-Time Index Template"; Critical = $false }
    )

    $missingCritical = $false
    $missingTemplates = @()

    # Ensure template directory structure
    if (-not (Test-Path $templateBaseDir)) { New-Item -ItemType Directory -Path $templateBaseDir -Force | Out-Null }
    @("decades", "states", "all-time", "latest-season", "index") | ForEach-Object {
        $subDir = Join-Path $templateBaseDir $_
        if (-not (Test-Path $subDir)) { New-Item -ItemType Directory -Path $subDir -Force | Out-Null }
    }

    foreach ($template in $requiredTemplates) {
        if (-not (Test-Path $template.Path)) {
            $color = if ($template.Critical) { "Red" } else { "Yellow" }
            Write-Host "Missing $($template.Description): $($template.Path)" -ForegroundColor $color
            if ($template.Critical) { $missingCritical = $true }
            $missingTemplates += $template
        }
    }

    if ($missingCritical) {
        Write-Warning "Critical templates are missing."
        return $false
    }
    return $true
}
#endregion Template Verification

#region Helper Functions
function Generate-TableRows {
    param (
        [Parameter(Mandatory=$true)][array]$Items,
        [Parameter(Mandatory=$true)][string]$Type  # "team" or "program"
    )

    $tableRows = $Items | ForEach-Object {
        if ($Type -eq "team") {
            @"
            <tr>
                <td>$($_.rank)</td>
                <td>$($_.team)</td>
                <td>$($_.season)</td>
                <td>$($_.combined)</td>
                <td>$($_.margin)</td>
                <td>$($_.win_loss)</td>
                <td>$($_.offense)</td>
                <td>$($_.defense)</td>
                <td>$($_.games_played)</td>
                <td>$($_.state)</td>
            </tr>
"@
        } else {
            @"
            <tr>
                <td>$($_.rank)</td>
                <td>$($_.program)</td>
                <td>$($_.seasons)</td>
                <td>$($_.combined)</td>
                <td>$($_.margin)</td>
                <td>$($_.win_loss)</td>
                <td>$($_.offense)</td>
                <td>$($_.defense)</td>
                <td>$($_.state)</td>
            </tr>
"@
        }
    }
    return $tableRows -join "`n"
}

function Generate-StandardizedJson {
    param (
        [string]$Type,
        [array]$Items,
        [object]$TopItem,
        [string]$Description,
        [string]$YearRange,
        [string]$OutputPath
    )

    $standardizedData = @{
        topItem = $TopItem
        items = $Items
        metadata = @{
            timestamp = (Get-Date).ToString("o")
            type = $Type
            yearRange = $YearRange
            totalItems = $Items.Count
            description = $Description
        }
    }

    $jsonContent = $standardizedData | ConvertTo-Json -Depth 10
    [System.IO.File]::WriteAllText($OutputPath, $jsonContent, [System.Text.Encoding]::UTF8)
}

function Generate-ComingSoonPage {
    param (
        [string]$OutputPath,
        [string]$Title,
        [string]$Message
    )

    $comingSoonHtml = @"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$Title - McKnight's American Football</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static-football-rankings/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="header-banner">
        <img src="/static-football-rankings/images/football-field-top.jpg" alt="Football Field Header" class="w-100" />
    </div>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center">
                <h1>$Title</h1>
                <div class="alert alert-info mt-4">
                    <h4 class="alert-heading">Coming Soon!</h4>
                    <p class="mb-0">$Message</p>
                </div>
                <a href="/static-football-rankings/index.html" class="btn btn-primary mt-3">Return to Home</a>
            </div>
        </div>
    </div>
</body>
</html>
"@
    $outputDir = Split-Path $OutputPath -Parent
    if (-not (Test-Path $outputDir)) { New-Item -ItemType Directory -Path $outputDir -Force | Out-Null }
    Set-Content -Path $OutputPath -Value $comingSoonHtml -Encoding UTF8
}

function Get-StateFullName {
    param([string]$StateCode)
    $stateNames = @{
        "AL"="Alabama";"AK"="Alaska";"AZ"="Arizona";"AR"="Arkansas";"CA"="California";"CO"="Colorado";
        "CT"="Connecticut";"DE"="Delaware";"FL"="Florida";"GA"="Georgia";"HI"="Hawaii";"ID"="Idaho";
        "IL"="Illinois";"IN"="Indiana";"IA"="Iowa";"KS"="Kansas";"KY"="Kentucky";"LA"="Louisiana";
        "ME"="Maine";"MD"="Maryland";"MA"="Massachusetts";"MI"="Michigan";"MN"="Minnesota";"MS"="Mississippi";
        "MO"="Missouri";"MT"="Montana";"NE"="Nebraska";"NV"="Nevada";"NH"="New Hampshire";"NJ"="New Jersey";
        "NM"="New Mexico";"NY"="New York";"NC"="North Carolina";"ND"="North Dakota";"OH"="Ohio";"OK"="Oklahoma";
        "OR"="Oregon";"PA"="Pennsylvania";"RI"="Rhode Island";"SC"="South Carolina";"SD"="South Dakota";
        "TN"="Tennessee";"TX"="Texas";"UT"="Utah";"VT"="Vermont";"VA"="Virginia";"WA"="Washington";
        "WV"="West Virginia";"WI"="Wisconsin";"WY"="Wyoming";
        "AB"="Alberta";"BC"="British Columbia";"MB"="Manitoba";"NB"="New Brunswick";"NS"="Nova Scotia";
        "QB"="Quebec";"SK"="Saskatchewan"
    }
    return $stateNames[$StateCode]
}
#endregion Helper Functions

#region Template Scripts
$tableControlsScript = @'
<script>
    const TableControls = {
        ROWS_PER_PAGE: 100,
        currentPage: 1,
        filteredRows: [],
        init() {
            const tableBody = document.querySelector('tbody');
            if (tableBody) {
                const rows = Array.from(tableBody.getElementsByTagName('tr'));
                this.filteredRows = rows;
                const totalRowsElement = document.getElementById('totalRows');
                if (totalRowsElement) totalRowsElement.textContent = rows.length;
                this.setupEventListeners();
                this.showPage(1);
            }
        },
        setupEventListeners() {
            const searchInput = document.getElementById('tableSearch');
            const pagination = document.getElementById('tablePagination');
            if (searchInput) {
                searchInput.value = '';
                searchInput.addEventListener('input', (e) => this.filterTable(e.target.value.toLowerCase()));
            }
            if (pagination) {
                pagination.addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button || button.parentElement.classList.contains('disabled')) return;
                    const page = button.dataset.page;
                    if (page === 'prev') this.showPage(this.currentPage - 1);
                    else if (page === 'next') this.showPage(this.currentPage + 1);
                    else this.showPage(parseInt(page));
                });
            }
        },
        filterTable(searchTerm) {
            const tableBody = document.querySelector('tbody');
            if (!tableBody) return;
            const rows = Array.from(tableBody.getElementsByTagName('tr'));
            this.filteredRows = searchTerm.trim() === '' ? rows : rows.filter(row => {
                const text = Array.from(row.getElementsByTagName('td')).map(cell => cell.textContent).join(' ').toLowerCase();
                return text.includes(searchTerm);
            });
            const totalRowsElement = document.getElementById('totalRows');
            if (totalRowsElement) totalRowsElement.textContent = this.filteredRows.length;
            this.showPage(1);
        },
        showPage(pageNum) {
            const tableBody = document.querySelector('tbody');
            if (!tableBody) return;
            this.currentPage = pageNum;
            const start = (pageNum - 1) * this.ROWS_PER_PAGE;
            const end = Math.min(start + this.ROWS_PER_PAGE, this.filteredRows.length);
            const allRows = Array.from(tableBody.getElementsByTagName('tr'));
            allRows.forEach(row => row.style.display = 'none');
            for (let i = start; i < end; i++) {
                if (this.filteredRows[i]) this.filteredRows[i].style.display = '';
            }
            const startRowElement = document.getElementById('startRow');
            const endRowElement = document.getElementById('endRow');
            if (startRowElement) startRowElement.textContent = this.filteredRows.length === 0 ? 0 : start + 1;
            if (endRowElement) endRowElement.textContent = end;
            this.updatePaginationControls();
        },
        updatePaginationControls() {
            const pagination = document.getElementById('tablePagination');
            if (!pagination) return;
            const totalPages = Math.ceil(this.filteredRows.length / this.ROWS_PER_PAGE);
            let html = [];
            html.push(`<li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}"><button class="page-link" data-page="prev">&laquo;</button></li>`);
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= this.currentPage - 2 && i <= this.currentPage + 2)) {
                    html.push(`<li class="page-item ${i === this.currentPage ? 'active' : ''}"><button class="page-link" data-page="${i}">${i}</button></li>`);
                } else if (i === this.currentPage - 3 || i === this.currentPage + 3) {
                    html.push('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
            }
            html.push(`<li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}"><button class="page-link" data-page="next">&raquo;</button></li>`);
            pagination.innerHTML = html.join('');
        }
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', () => TableControls.init());
    else TableControls.init();
</script>
'@

$commentCode = @'
<script>
const VERCEL_API_BASE = "https://static-football-rankings.vercel.app/api";
// ... (Shortened for readability, assume standard auth/comment logic is here) ...
async function checkLoginStatus() {
    try {
        const res = await fetch(`${VERCEL_API_BASE}/auth/status`, { credentials: 'include' });
        const data = await res.json();
        if (data.success && data.loggedIn) {
            document.getElementById('commentForm').style.display = 'block';
            document.getElementById('authorName').textContent = data.user.name || 'Anonymous';
        } else {
            document.getElementById('commentForm').style.display = 'none';
        }
    } catch (e) { console.warn('Login status error:', e); }
}
// ...
(async function initPage() { await checkLoginStatus(); })();
</script>
'@
#endregion Template Scripts

#region Processing Functions
function Process-Template {
    param (
        [Parameter(Mandatory=$true)][string]$TemplatePath,
        [Parameter(Mandatory=$true)][hashtable]$Replacements,
        [Parameter(Mandatory=$true)][object]$Data,
        [Parameter(Mandatory=$true)][string]$Type
    )

    Write-Host "  Processing template: $TemplatePath" -ForegroundColor Gray
    
    $template = Get-Content $TemplatePath -Raw
    $template = $template -replace '<userStyle>Normal</userStyle>', ''

    $currentDate = Get-Date -Format "M/d/yyyy"
    $template = $template -replace '(<span id="lastUpdated">)[^<]*(</span>)', "`${1}$currentDate`${2}"

    foreach ($key in $Replacements.Keys) {
        if ($Replacements[$key]) {
            $template = $template -replace $key, $Replacements[$key]
        }
    }

    $cleanTableControls = $tableControlsScript -replace '<userStyle>Normal</userStyle>', ''
    $cleanComments = $commentCode -replace '<userStyle>Normal</userStyle>', ''
    $template = $template -replace 'TABLE_CONTROLS_SCRIPT', $cleanTableControls
    $template = $template -replace 'COMMENTS_SCRIPT_PLACEHOLDER', $cleanComments
    $template = $template -replace 'TIMESTAMP', $currentDate

    $tableRows = Generate-TableRows -Items $Data.items -Type $Type
    $template = $template -replace 'TABLE_ROWS', $tableRows

    return $template
}

function Process-DecadeData {
    param (
        [string]$DecadeName,
        [string]$StartYear,
        [string]$EndYear,
        [string]$DisplayName
    )

    Write-Host "Processing $DisplayName..." -ForegroundColor Cyan
    $commonReplacements = @{
        'DECADE_DISPLAY_NAME' = $DisplayName
        'DECADE_NAME' = $DecadeName
        'DECADE_START' = $StartYear
        'DECADE_END' = $EndYear
    }

    # Programs
    $programJsonPath = Join-Path $dataDir "decades\programs\programs-$DecadeName.json"
    if (Test-Path $programJsonPath) {
        try {
            $jsonContent = Get-Content $programJsonPath -Raw | ConvertFrom-Json
            Generate-StandardizedJson -Type "decade-programs" -Items $jsonContent.items -TopItem $jsonContent.topItem -Description "$DisplayName Programs" -YearRange "$StartYear-$EndYear" -OutputPath $programJsonPath
            
            $templatePath = Join-Path $templateBaseDir "decades\decade-programs-template.html"
            $outputPath = Join-Path $outputBaseDir "decades\$DecadeName-programs.html"
            if (Test-Path $templatePath) {
                $template = Get-Content $templatePath -Raw
                # Fix meta tag specifically for this file
                $template = $template -replace '<meta name="data-file" content="[^"]*">', "<meta name=`"data-file`" content=`"/static-football-rankings/data/decades/programs/programs-$DecadeName.json`">"
                
                $processedTemplate = Process-Template -TemplatePath $templatePath -Replacements $commonReplacements -Data $jsonContent -Type "program"
                # Re-apply meta tag fix just in case Process-Template reverted it
                $processedTemplate = $processedTemplate -replace '<meta name="data-file" content="[^"]*">', "<meta name=`"data-file`" content=`"/static-football-rankings/data/decades/programs/programs-$DecadeName.json`">"
                
                Set-Content -Path $outputPath -Value $processedTemplate -Encoding UTF8
            }
        } catch { Write-Error "Error processing $DecadeName programs: $_" }
    }

    # Teams
    $teamJsonPath = Join-Path $dataDir "decades\teams\teams-$DecadeName.json"
    if (Test-Path $teamJsonPath) {
        try {
            $jsonContent = Get-Content $teamJsonPath -Raw | ConvertFrom-Json
            Generate-StandardizedJson -Type "decade-teams" -Items $jsonContent.items -TopItem $jsonContent.topItem -Description "$DisplayName Teams" -YearRange "$StartYear-$EndYear" -OutputPath $teamJsonPath
            
            $templatePath = Join-Path $templateBaseDir "decades\decade-teams-template.html"
            $outputPath = Join-Path $outputBaseDir "decades\$DecadeName-teams.html"
            if (Test-Path $templatePath) {
                $template = Get-Content $templatePath -Raw
                $template = $template -replace '<meta name="data-file" content="[^"]*">', "<meta name=`"data-file`" content=`"/static-football-rankings/data/decades/teams/teams-$DecadeName.json`">"
                
                $processedTemplate = Process-Template -TemplatePath $templatePath -Replacements $commonReplacements -Data $jsonContent -Type "team"
                $processedTemplate = $processedTemplate -replace '<meta name="data-file" content="[^"]*">', "<meta name=`"data-file`" content=`"/static-football-rankings/data/decades/teams/teams-$DecadeName.json`">"
                
                Set-Content -Path $outputPath -Value $processedTemplate -Encoding UTF8
            }
        } catch { Write-Error "Error processing $DecadeName teams: $_" }
    }
}

function Process-StateData {
    param ([string]$StateCode)
    $stateName = Get-StateFullName -StateCode $StateCode
    Write-Host "Processing state: $StateCode ($stateName)" -ForegroundColor Cyan
    
    # State Teams
    $jsonPath = Join-Path $dataDir "states\teams\state-teams-$StateCode.json"
    if (Test-Path $jsonPath) {
        try {
            $teamData = Get-Content $jsonPath -Raw | ConvertFrom-Json
            $templatePath = Join-Path $templateBaseDir "states\state-teams-template.html"
            $outputPath = Join-Path $outputBaseDir "states\$StateCode-teams.html"
            if (Test-Path $templatePath) {
                $replacements = @{ 'STATE_CODE'=$StateCode; 'STATE_NAME'=$stateName }
                $processed = Process-Template -TemplatePath $templatePath -Replacements $replacements -Data $teamData -Type "team"
                Set-Content -Path $outputPath -Value $processed -Encoding UTF8
            }
        } catch { Write-Error "Error processing $StateCode teams: $_" }
    }

    # State Programs
    $programJsonPath = Join-Path $dataDir "states\programs\state-programs-$StateCode.json"
    if (Test-Path $programJsonPath) {
        try {
            $programData = Get-Content $programJsonPath -Raw | ConvertFrom-Json
            $templatePath = Join-Path $templateBaseDir "states\state-programs-template.html"
            $outputPath = Join-Path $outputBaseDir "states\$StateCode-programs.html"
            if (Test-Path $templatePath) {
                $replacements = @{ 'STATE_CODE'=$StateCode; 'STATE_NAME'=$stateName }
                $processed = Process-Template -TemplatePath $templatePath -Replacements $replacements -Data $programData -Type "program"
                Set-Content -Path $outputPath -Value $processed -Encoding UTF8
            }
        } catch { Write-Error "Error processing $StateCode programs: $_" }
    } else {
        Generate-ComingSoonPage -OutputPath (Join-Path $outputBaseDir "states\$StateCode-programs.html") -Title "$StateCode Programs" -Message "Program rankings for $StateCode are being compiled."
    }
}

function Process-AllTimeData {
    param ([string]$Category, [string]$Threshold = $null)
    Write-Host "Processing All-Time $Category $(if($Threshold){"($Threshold+)"})" -ForegroundColor Cyan

    $jsonFileName = if ($Category -eq "teams") { "all-time-teams.json" } else { "all-time-programs-$Threshold.json" }
    $jsonPath = Join-Path $dataDir "all-time\$jsonFileName"

    if (Test-Path $jsonPath) {
        try {
            $jsonData = Get-Content $jsonPath -Raw | ConvertFrom-Json
            # Generate Standardized JSON
            if ($Category -eq "teams") {
                Generate-StandardizedJson -Type "all-time-teams" -Items $jsonData.items -TopItem $jsonData.topItem -Description "All-Time Greatest Teams" -YearRange "all-time" -OutputPath $jsonPath
            } else {
                Generate-StandardizedJson -Type "all-time-programs" -Items $jsonData.items -TopItem $jsonData.topItem -Description "All-Time Programs $Threshold+ Seasons" -YearRange "all-time" -OutputPath $jsonPath
            }

            # Template
            $templateName = if ($Category -eq "teams") { "all-time-teams-template.html" } else { "all-time-programs-template.html" }
            $templatePath = Join-Path $templateBaseDir "all-time\$templateName"
            $outputFileName = if ($Category -eq "teams") { "teams.html" } else { "programs-$Threshold-plus.html" }
            $outputPath = Join-Path $outputBaseDir "all-time\$outputFileName"

            if (Test-Path $templatePath) {
                $pageTitle = if ($Category -eq "teams") { "All-Time Greatest Teams" } else { "All-Time Programs $Threshold+ Seasons" }
                $replacements = @{ 'PAGE_TITLE'=$pageTitle }
                if ($Category -eq "programs") { $replacements.Add('PROGRAM_THRESHOLD', $Threshold) }
                
                $processed = Process-Template -TemplatePath $templatePath -Replacements $replacements -Data $jsonData -Type $(if($Category -eq "teams"){"team"}else{"program"})
                Set-Content -Path $outputPath -Value $processed -Encoding UTF8
            }
        } catch { Write-Error "Error processing All-Time $Category: $_" }
    } else {
        Write-Warning "JSON file not found: $jsonPath"
    }
}

function Process-LatestSeasonData {
    Write-Host "Processing Latest Season..." -ForegroundColor Cyan
    $jsonPath = Join-Path $dataDir "latest\latest-teams.json"
    $outputPath = Join-Path $outputBaseDir "latest-season\index.html"

    if (Test-Path $jsonPath) {
        try {
            $jsonData = Get-Content $jsonPath -Raw | ConvertFrom-Json
            Generate-StandardizedJson -Type "latest-teams" -Items $jsonData.items -TopItem $jsonData.topItem -Description "Latest Season Rankings" -YearRange "latest" -OutputPath $jsonPath
            
            $templatePath = Join-Path $templateBaseDir "latest-season\latest-season-template.html"
            if (Test-Path $templatePath) {
                $processed = Process-Template -TemplatePath $templatePath -Replacements @{} -Data $jsonData -Type "team"
                Set-Content -Path $outputPath -Value $processed -Encoding UTF8
            } else {
                Generate-ComingSoonPage -OutputPath $outputPath -Title "Latest Season Rankings" -Message "Template missing."
            }
        } catch {
            Write-Error "Error processing latest season: $_"
            Generate-ComingSoonPage -OutputPath $outputPath -Title "Latest Season Rankings" -Message "Error processing data."
        }
    } else {
        Generate-ComingSoonPage -OutputPath $outputPath -Title "Latest Season Rankings" -Message "Rankings are being compiled."
    }
}

function Process-NationalChampions {
    Write-Host "Processing National Champions..." -ForegroundColor Cyan
    $jsonPath = Join-Path $dataDir "national-champions\national-champions.json"
    $outputPath = Join-Path $outputBaseDir "national-champions.html"
    
    if (Test-Path $jsonPath) {
        try {
            $championsData = Get-Content $jsonPath -Raw | ConvertFrom-Json
            $templatePath = Join-Path $templateBaseDir "national-champions-template.html"
            if (Test-Path $templatePath) {
                $template = Get-Content $templatePath -Raw
                $template = $template -replace 'TABLE_CONTROLS_SCRIPT', $tableControlsScript
                $template = $template -replace 'COMMENTS_SCRIPT_PLACEHOLDER', $commentCode
                $template = $template -replace 'TIMESTAMP', (Get-Date -Format "M/d/yyyy")
                
                $tableRows = $championsData | ForEach-Object {
                    "<tr><td>$($_.year)</td><td>$($_.team)</td><td>$($_.state)</td><td>$($_.source)</td><td>$($_.record)</td><td>$($_.rating)</td></tr>"
                }
                $template = $template -replace 'TABLE_ROWS', ($tableRows -join "`n")
                Set-Content -Path $outputPath -Value $template -Encoding UTF8
            }
        } catch { Write-Error "Error processing National Champions: $_" }
    }
}
#endregion Processing Functions

#region Main Script Execution
try {
    Write-Host "Starting Main Execution..." -ForegroundColor Green
    
    if (-not (Test-RequiredTemplates)) {
        Write-Warning "Missing templates may cause incomplete pages."
        Start-Sleep -Seconds 2
    }

    # 1. Process Decades
    $decades = @(
        [ordered]@{ Name="pre1900"; StartYear=1877; EndYear=1899; DisplayName="Pre-1900s" },
        [ordered]@{ Name="1900s"; StartYear=1900; EndYear=1909; DisplayName="1900s" },
        [ordered]@{ Name="1910s"; StartYear=1910; EndYear=1919; DisplayName="1910s" },
        [ordered]@{ Name="1920s"; StartYear=1920; EndYear=1929; DisplayName="1920s" },
        [ordered]@{ Name="1930s"; StartYear=1930; EndYear=1939; DisplayName="1930s" },
        [ordered]@{ Name="1940s"; StartYear=1940; EndYear=1949; DisplayName="1940s" },
        [ordered]@{ Name="1950s"; StartYear=1950; EndYear=1959; DisplayName="1950s" },
        [ordered]@{ Name="1960s"; StartYear=1960; EndYear=1969; DisplayName="1960s" },
        [ordered]@{ Name="1970s"; StartYear=1970; EndYear=1979; DisplayName="1970s" },
        [ordered]@{ Name="1980s"; StartYear=1980; EndYear=1989; DisplayName="1980s" },
        [ordered]@{ Name="1990s"; StartYear=1990; EndYear=1999; DisplayName="1990s" },
        [ordered]@{ Name="2000s"; StartYear=2000; EndYear=2009; DisplayName="2000s" },
        [ordered]@{ Name="2010s"; StartYear=2010; EndYear=2019; DisplayName="2010s" },
        [ordered]@{ Name="2020s"; StartYear=2020; EndYear=2029; DisplayName="2020s" }
    )
    foreach ($d in $decades) { Process-DecadeData -DecadeName $d.Name -StartYear $d.StartYear -EndYear $d.EndYear -DisplayName $d.DisplayName }

    # 2. Process States
    $stateTeamsDir = Join-Path $dataDir "states\teams"
    if (Test-Path $stateTeamsDir) {
        $stateFiles = Get-ChildItem $stateTeamsDir -Filter "state-teams-*.json"
        $stateCodes = $stateFiles | ForEach-Object { $_.BaseName -replace 'state-teams-', '' } | Sort-Object -Unique
        foreach ($sc in $stateCodes) { Process-StateData -StateCode $sc }
    }

    # 3. Process All-Time
    if (Test-Path (Join-Path $dataDir "all-time\all-time-teams.json")) { Process-AllTimeData -Category "teams" }
    @("25", "50", "100") | ForEach-Object { Process-AllTimeData -Category "programs" -Threshold $_ }

    # 4. Process Latest Season
    Process-LatestSeasonData

    # 5. Process National Champions
    Process-NationalChampions

    # 6. Generate Indices
    Write-Host "Generating Index Pages..." -ForegroundColor Cyan
    
    # Decade Index
    $decadeIndexPath = Join-Path $outputBaseDir "decades\index.html"
    $decadeIndexTemplatePath = Join-Path $templateBaseDir "index\decades-index-template.html"
    if (Test-Path $decadeIndexTemplatePath) {
        $tpl = Get-Content $decadeIndexTemplatePath -Raw
        $cards = $decades | ForEach-Object {
            @"
<div class="col-md-6 mb-4">
    <div class="card h-100">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">$($_.DisplayName)</h5>
            <p class="card-text">Top teams and programs from $($_.StartYear) to $($_.EndYear)</p>
            <div class="mt-auto">
                <a href="$($_.Name)-teams.html" class="btn btn-primary me-2">Season Rankings</a>
                <a href="$($_.Name)-programs.html" class="btn btn-outline-primary">Program Rankings</a>
            </div>
        </div>
    </div>
</div>
"@
        }
        $final = $tpl -replace 'DECADE_CARDS', ($cards -join "`n")
        Set-Content -Path $decadeIndexPath -Value $final -Encoding UTF8
    }

    # State Index
    $statesIndexPath = Join-Path $outputBaseDir "states\index.html"
    $statesIndexTemplatePath = Join-Path $templateBaseDir "index\states-index-template.html"
    if (Test-Path $statesIndexTemplatePath) {
        $tpl = Get-Content $statesIndexTemplatePath -Raw
        $cards = if ($stateCodes) {
            $stateCodes | ForEach-Object {
                @"
<div class="col-md-4 mb-4">
    <div class="card h-100">
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">$_</h5>
            <div class="mt-auto">
                <a href="$_-teams.html" class="btn btn-primary me-2">Teams</a>
                <a href="$_-programs.html" class="btn btn-outline-primary">Programs</a>
            </div>
        </div>
    </div>
</div>
"@
            }
        } else { "" }
        $final = $tpl -replace 'STATE_CARDS', ($cards -join "`n")
        Set-Content -Path $statesIndexPath -Value $final -Encoding UTF8
    }
    
    # All-Time Index
    $allTimeIndexPath = Join-Path $outputBaseDir "all-time\index.html"
    $allTimeIndexTemplatePath = Join-Path $templateBaseDir "index\all-time-index-template.html"
    if (Test-Path $allTimeIndexTemplatePath) {
        Copy-Item -Path $allTimeIndexTemplatePath -Destination $allTimeIndexPath -Force
    }

    Write-Host "`nPage generation completed successfully!" -ForegroundColor Green

} catch {
    Write-Error "Generation failed: $_"
    exit 1
} finally {
    Write-Host "Script execution completed." -ForegroundColor Green
}
#endregion Main Script Execution